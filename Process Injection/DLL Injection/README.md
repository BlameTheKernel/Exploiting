Steps for DLL injection:

1. Locate the target process by traversing the running processes and call OpenProcess for obtaining a handle to it.

2. Allocate the space for injecting the path of the malicious DLL file to the target process with a call to VirtualAllocEx with the targeted process handle.

3. Write the path of the DLL into the allocated space with WriteProcessMemory.

4. Retrieve the address of LoadLibrary from kernel32.dll, that given the path to DLL, loads it into memory (does not execute it though).

5. Call CreateRemoteThread passing it the address of LoadLibrary causing the injected DLL fileâ€™s path to be loaded into memory and executed.

The downside of this technique is that the malicious DLL file must be stored on disk, which exposes it to detection by regular security solutions





Injecting DLL into running processes using thread hijacking. No remote thread is created, only existing thread is used for injection.

The injector injects shellcode into the target process, and then a running thread in the target process is hijacked to execute the injected code. The injected code calls the LoadLibrary function to load the DLL.

Flow of injection

1) Parse the DLL name and the target process ID from command line.

2) Allocate buffer for the shellcode and DLL name.

3) Copy the shellcode to the buffer.

4) Copy the DLL name to the end of shellcode.

5) Open the target process handle.

6) Allocate memory in the target process.

7) Find a running thread to hijack.

8) Get the context of the target thread.

9) Write the eip register to the shellcode.

10) Write the address of LoadLibrary to the shellcode.

11) Write the shellcode and DLL name to the target process.

12) Hijack a running thread in the target process to execute the shellcode.

13) The hijacked thread executes the shellcode. The shellcode calls the LoadLibrary function to load the DLL.

14) The shellcode returns, and the thread continue to execute its own code.
